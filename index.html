<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.48" />
    <meta name="description" content="">


    <link rel="shortcut icon" href="/go-concurrency-limits/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/go-concurrency-limits/images/favicon.png" type="image/x-icon" />
    <title> :: Go Concurrency Limit</title>

    
    <link href="/go-concurrency-limits/css/nucleus.css?1554390877" rel="stylesheet">
    <link href="/go-concurrency-limits/css/fontawesome-all.min.css?1554390877" rel="stylesheet">
    <link href="/go-concurrency-limits/css/hybrid.css?1554390877" rel="stylesheet">
    <link href="/go-concurrency-limits/css/featherlight.min.css?1554390877" rel="stylesheet">
    <link href="/go-concurrency-limits/css/perfect-scrollbar.min.css?1554390877" rel="stylesheet">
    <link href="/go-concurrency-limits/css/auto-complete.css?1554390877" rel="stylesheet">
    <link href="/go-concurrency-limits/css/theme.css?1554390877" rel="stylesheet">
    <link href="/go-concurrency-limits/css/hugo-theme.css?1554390877" rel="stylesheet">
    

    <script src="/go-concurrency-limits/js/jquery-2.x.min.js?1554390877"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/go-concurrency-limits/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="http://getgrav.org">
  <svg id="grav-logo" width="100%" height="100%" viewBox="0 0 504 140" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <path d="M235.832,71.564l-7.98,-0.001c-1.213,0.001 -2.197,0.987 -2.197,2.204l0,15.327l-0.158,0.132c-4.696,3.962 -10.634,6.14 -16.719,6.14c-14.356,0 -26.034,-11.68 -26.034,-26.037c0,-14.358 11.678,-26.035 26.034,-26.035c5.582,0 10.919,1.767 15.437,5.113c0.877,0.649 2.093,0.56 2.866,-0.211l5.69,-5.69c0.444,-0.442 0.675,-1.055 0.639,-1.681c-0.034,-0.627 -0.336,-1.206 -0.828,-1.597c-6.76,-5.363 -15.214,-8.314 -23.805,-8.314c-21.18,0 -38.414,17.233 -38.414,38.415c0,21.183 17.234,38.415 38.414,38.415c10.937,0 21.397,-4.705 28.698,-12.914c0.358,-0.403 0.556,-0.921 0.556,-1.46l0,-19.603c0,-1.217 -0.985,-2.203 -2.2,-2.203"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M502.794,34.445c-0.408,-0.616 -1.1,-0.989 -1.838,-0.989l-8.684,0c-0.879,0 -1.673,0.522 -2.022,1.329l-24.483,56.839l-24.92,-56.852c-0.352,-0.799 -1.142,-1.316 -2.012,-1.316l-8.713,0c-0.744,0 -1.44,0.373 -1.843,0.995c-0.408,0.623 -0.476,1.408 -0.174,2.09l30.186,68.858c0.352,0.799 1.143,1.317 2.017,1.317l10.992,0c0.879,0 1.673,-0.527 2.021,-1.329l29.655,-68.861c0.289,-0.68 0.222,-1.461 -0.182,-2.081"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M388.683,34.772c-0.353,-0.798 -1.142,-1.316 -2.017,-1.316l-10.988,0c-0.879,0 -1.673,0.522 -2.021,1.329l-29.655,68.861c-0.294,0.675 -0.226,1.46 0.182,2.077c0.407,0.619 1.096,0.993 1.838,0.993l8.684,0c0.879,0 1.673,-0.526 2.022,-1.329l24.478,-56.842l24.92,56.854c0.353,0.798 1.143,1.317 2.013,1.317l8.717,0c0.744,0 1.44,-0.374 1.843,-0.993c0.408,-0.624 0.471,-1.41 0.174,-2.094l-30.19,-68.857Z"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M309.196,81.525l0.476,-0.229c8.675,-4.191 14.279,-13.087 14.279,-22.667c0,-13.881 -11.295,-25.174 -25.176,-25.174l-31.863,0c-1.214,0 -2.199,0.988 -2.199,2.202l0,68.855c0,1.219 0.985,2.204 2.199,2.204l7.979,0c1.214,0 2.2,-0.985 2.2,-2.204l0,-58.679l21.684,0c7.059,0 12.799,5.739 12.799,12.796c0,5.885 -3.996,10.989 -9.728,12.408c-1.032,0.261 -2.064,0.393 -3.071,0.393l-7.977,0c-0.829,0 -1.585,0.467 -1.959,1.205c-0.378,0.74 -0.305,1.625 0.187,2.296l22.62,30.884c0.412,0.566 1.07,0.901 1.771,0.901l9.915,0c0.827,0 1.587,-0.467 1.96,-1.207c0.378,-0.742 0.302,-1.629 -0.186,-2.296l-15.91,-21.688Z"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M107.191,80.969c-7.255,-4.794 -11.4,-8.845 -15.011,-16.109c-2.47,4.977 -8.236,12.376 -17.962,18.198c-4.856,15.106 -27.954,44.015 -35.43,39.916c-2.213,-1.212 -2.633,-2.808 -2.133,-4.456c0.536,-4.129 9.078,-13.62 9.078,-13.62c0,0 0.18,1.992 2.913,6.187c-3.609,-11.205 5.965,-25.031 8.5,-29.738c3.985,-1.269 4.274,-6.387 4.274,-6.387c0.255,-7.909 -3.278,-13.635 -6.701,-17.059c2.459,3.002 3.255,7.539 3.372,11.694l0,0.023c0.012,0.469 0.012,0.93 0.011,1.39c-0.117,3.439 -1.157,8.19 -3.383,8.19l0.006,0.03c-2.289,-0.098 -5.115,0.391 -7.639,1.18l-5.582,1.334c0,0 2.977,-0.136 4.584,1.252c-1.79,2.915 -5.769,6.533 -10.206,8.588c-6.457,2.995 -8.312,-2.964 -5.034,-6.838c0.805,-0.946 1.618,-1.745 2.387,-2.399c-0.495,-0.513 -0.807,-1.198 -0.889,-2.068c-0.001,-0.005 -0.004,-0.009 -0.005,-0.013c-0.45,-1.977 -0.202,-4.543 2.596,-8.623c0.551,-0.863 1.214,-1.748 2.007,-2.647c0.025,-0.031 0.046,-0.059 0.072,-0.089c0.034,-0.042 0.072,-0.08 0.108,-0.121c0.02,-0.023 0.039,-0.045 0.059,-0.068c0.2,-0.228 0.413,-0.45 0.639,-0.663c3.334,-3.414 8.599,-6.966 16.897,-10.152c9.675,-14.223 13.219,-16.89 13.219,-16.89c1.071,-1.096 2.943,-2.458 3.632,-2.805c-5.053,-8.781 -6.074,-21.158 -4.75,-24.493c-0.107,0.18 -0.206,0.365 -0.287,0.556c0.49,-1.143 0.819,-1.509 1.328,-2.111c1.381,-1.632 6.058,-2.488 7.737,0.971c0.895,1.844 1.063,4.232 1.034,6.023c-3.704,-0.193 -7.063,4.036 -7.063,4.036c0,0 3.067,-1.448 6.879,-1.473c0,0 1.015,0.883 2.283,2.542c-1.712,3.213 -4.524,10.021 -2.488,17.168c0.338,1.408 0.849,2.619 1.483,3.648c0.024,0.045 0.044,0.089 0.069,0.135c0.051,0.066 0.096,0.122 0.144,0.183c3.368,5.072 9.542,5.665 9.542,5.665c-2.906,-1.45 -5.274,-3.76 -6.816,-6.56c-0.8,-1.498 -1.291,-2.762 -1.592,-3.761c-1.636,-6.313 0.771,-9.999 2.149,-12.471c3.17,-4.917 8.944,-7.893 15.151,-7.185c8.712,0.995 14.968,8.862 13.973,17.571c-0.608,5.321 -3.781,9.723 -8.142,12.117c1.049,2.839 -0.073,6.28 -0.073,6.28c2.642,3.323 2.758,5.238 2.667,7.017c-3.357,-0.565 -6.618,1.701 -6.618,1.701c0,0 6.476,-1.546 10.238,1.81c2.446,2.631 4.078,5.009 5.051,6.766c1.393,2.505 7.859,2.683 7.123,7.188c-0.737,4.499 -5.669,4.542 -13.401,-0.56M69.571,0c-38.424,0 -69.571,31.148 -69.571,69.567c0,38.422 31.147,69.573 69.571,69.573c38.42,0 69.568,-31.151 69.568,-69.573c0,-38.42 -31.148,-69.567 -69.568,-69.567"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M73.796,51.693c0.813,-0.814 0.813,-2.134 0,-2.947c-0.815,-0.814 -2.133,-0.814 -2.947,0c-0.815,0.813 -0.815,2.133 0,2.947c0.814,0.813 2.132,0.813 2.947,0" style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M66.445,53.149c-0.814,0.813 -0.814,2.133 0,2.947c0.813,0.814 2.133,0.814 2.947,0c0.813,-0.814 0.813,-2.134 0,-2.947c-0.814,-0.813 -2.134,-0.813 -2.947,0" style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M79.231,54.233c-1.274,-1.274 -3.339,-1.272 -4.611,0l-2.713,2.712c-1.274,1.275 -1.274,3.339 0,4.612l2.978,2.978c1.274,1.275 3.338,1.274 4.611,0l2.712,-2.712c1.274,-1.274 1.274,-3.339 0,-4.612l-2.977,-2.978Z" style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M95.759,41.445c-2.151,-2.578 1.869,-7.257 4.391,-4.463c4.645,5.148 -2.237,7.041 -4.391,4.463M105.004,44.132c3.442,-6.553 -1.427,-10.381 -4.773,-13.523c-5.36,-5.039 -10.706,-7.217 -16.811,-0.241c-6.102,6.977 -2.226,15.068 3.356,19.061c5.584,3.994 14.782,1.255 18.228,-5.297"
      style="fill:#000;fill-rule:nonzero;"></path>
  </svg>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-close"></i></span>
</div>

<script type="text/javascript" src="/go-concurrency-limits/js/lunr.min.js?1554390877"></script>
<script type="text/javascript" src="/go-concurrency-limits/js/auto-complete.js?1554390877"></script>
<script type="text/javascript">
    
        var baseurl = '\/go-concurrency-limits';
    
</script>
<script type="text/javascript" src="/go-concurrency-limits/js/search.js?1554390877"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
         
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              

        
        <div id="body-inner">
          

        

<span id="sidebar-toggle-span">
<a href="#" id="sidebar-toggle" data-sidebar-toggle=""><i class="fas fa-bars"></i> navigation</a>
</span>

 


<p><a href="https://travis-ci.org/platinummonkey/go-concurrency-limits"><img src="https://travis-ci.org/platinummonkey/go-concurrency-limits.svg?branch=master" alt="Build Status" /></a> <a href="https://coveralls.io/github/platinummonkey/go-concurrency-limits"><img src="https://img.shields.io/coveralls/github/platinummonkey/go-concurrency-limits/master.svg" alt="Coverage Status" /></a></p>

<h1 id="overview">Overview</h1>

<p>Go Implementation of Netflix/concurrency-limits Java  Library that
implements and integrates concepts from TCP congestion control to
auto-detect concurrency limits to achieve optimal throughput with
optimal latency.</p>

<h1 id="background">Background</h1>

<p>When thinking of service availability operators traditionally think in
terms of RPS (requests per second). Stress tests are normally performed
to determine the RPS at which point the service tips over. RPS limits
are then set somewhere below this tipping point (say 75% of this value)
and enforced via a token bucket. However, in large distributed systems
that auto-scale this value quickly goes out of date and the service
falls over anyway and becomes non-responsive to a point where it is
unable to gracefully shed load. Instead of thinking in terms of RPS, we
should be thinking in terms of concurrent request where we apply
queuing theory to determine the number of concurrent requests a service
can handle before a queue starts to build up, latencies increase and
the service eventually exhausts a hard limit such as CPU, memory, disk
or network. This relationship is covered very nicely with Little&rsquo;s Law
where <code>Limit = Average RPS * Average Latency</code>.</p>

<p>Concurrency limits are very easy to enforce but difficult to determine
as they would require operators to fully understand the hardware
services run on and coordinate how they scale. Instead we&rsquo;d prefer to
measure or estimate the concurrency limits at each point in the network.
As systems scale and hit limits each node will adjust and enforce its
local view of the limit. To estimate the limit we borrow from common
TCP congestion control algorithms by equating a system&rsquo;s concurrency
limit to a TCP congestion window.</p>

<p>Before applying the algorithm we need to set some ground rules.
* We accept that every system has an inherent concurrency limit that is
  determined by a hard resources, such as number of CPU cores.
* We accept that this limit can change as a system auto-scales.
* For large systems it&rsquo;s impossible to know all the hard resource limits
  so we&rsquo;d rather measure and estimate that limit.
* We use minimum latency measurements to determine when queuing happens.
* We use timeouts and rejected requests to aggressively back off.</p>

<p>A quick note on using minimum latency. Not all requests are the same
and can have varying latency distributions but do tend to converge on
an average. But we&rsquo;re not trying to measure average latency. We&rsquo;re
trying to detect queuing using the minimum observed latency. That is,
regardless of how long it takes to process a request, if there is
queuing even the fastest requests to process will sit in the queue and
the overall observed latency in a sampling window, especially the
minimum observed latency, will increase. When the queue is small the
limit can be increased. When the queue grows the limit is decreased.</p>

<h1 id="limit-algorithms">Limit algorithms</h1>

<h2 id="vegas">Vegas</h2>

<p>Delay based algorithm where the bottleneck queue is estimated as</p>

<pre><code>L * (1 - minRTT/sampleRtt)
</code></pre>

<p>At the end of each sampling window the limit is increased by 1 if the
queue is less than alpha (typically a value between 2-3) or decreased
by 1 if the queue is greater than beta (typically a value between 4-6
requests)</p>

<h1 id="enforcement-strategies">Enforcement Strategies</h1>

<h2 id="simple">Simple</h2>

<p>In the simplest use case we don&rsquo;t want to differentiate between
requests and so enforce a single gauge of the number of in-flight
requests.  Requests are rejected immediately once the gauge value
equals the limit.</p>

<h2 id="percentage">Percentage</h2>

<p>For more complex systems it&rsquo;s desirable to provide certain quality of
service guarantees while still making efficient use of resources.  Here
we guarantee specific types of requests get a certain percentage of the
concurrency limit.  For example, a system that takes both live and
batch traffic may want to give live traffic 100% of the limit during
heavy load and is OK with starving batch traffic. Or, a system may want
to guarantee that 50% of the limit is given to write traffic so writes
are never starved.</p>

<h1 id="integrations">Integrations</h1>

<h2 id="grpc">GRPC</h2>

<p>A concurrency limiter may be installed either on the server or client.
The choice of limiter depends on your use case. For the most part it is
recommended to use a dynamic delay based limiter such as the VegasLimit
on the server and either a pure loss based (AIMDLimit) or combined loss
and delay based limiter on the client.</p>

<h3 id="server-limiter">Server limiter</h3>

<p>The purpose of the server limiter is to protect the server from either
increased client traffic (batch apps or retry storms) or latency spikes
from a dependent service.  With the limiter installed the server can
ensure that latencies remain low by rejecting excess traffic with
<code>Status.UNAVAILABLE</code> errors.</p>

<p>In this example a GRPC server is configured with a single adaptive
limiter that is shared among batch and live traffic with live traffic
guaranteed 90% of throughput and 10% guaranteed to batch.  For
simplicity we just expect the client to send a &ldquo;group&rdquo; header
identifying it as &lsquo;live&rsquo; or &lsquo;batch&rsquo;.  Ideally this should be done
using TLS certificates and a server side lookup of identity to
grouping.  Any requests not identified as either live or batch may
only use excess capacity.</p>

<pre><code class="language-golang">import (
    gclGrpc &quot;github.com/platnummonkey/go-concurrency-limits/grpc&quot;
)

// setup grpc server with this option
serverOption := grpc.UnaryInterceptor(
    gclGrpc.UnaryServerInterceptor(
        gclGrpc.WithLimiter(...),
        gclGrpc.WithServerResponseTypeClassifier(..),
    ),
)
</code></pre>

<h3 id="client-limiter">Client limiter</h3>

<p>There are two main use cases for client side limiters. A client side
limiter can protect the client service from its dependent services by
failing fast and serving a degraded experience to its client instead of
having its latency go up and its resources eventually exhausted. For
batch applications that call other services a client side limiter acts
as a backpressure mechanism ensuring that the batch application does
not put unnecessary load on dependent services.</p>

<p>In this example a GRPC client will use a blocking version of the
VegasLimit to block the caller when the limit has been reached.</p>

<pre><code class="language-golang">import (
    gclGrpc &quot;github.com/platnummonkey/go-concurrency-limits/grpc&quot;
)

// setup grpc client with this option
dialOption := grpc.WithUnaryInterceptor(
    gclGrpc.UnaryClientInterceptor(
        gclGrpc.WithLimiter(...),
        gclGrpc.WithClientResponseTypeClassifier(...),
    ),
)
</code></pre>
	
  
        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
            
        
        
        


        
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/go-concurrency-limits/js/clipboard.min.js?1554390877"></script>
    <script src="/go-concurrency-limits/js/perfect-scrollbar.min.js?1554390877"></script>
    <script src="/go-concurrency-limits/js/perfect-scrollbar.jquery.min.js?1554390877"></script>
    <script src="/go-concurrency-limits/js/jquery.sticky.js?1554390877"></script>
    <script src="/go-concurrency-limits/js/featherlight.min.js?1554390877"></script>
    <script src="/go-concurrency-limits/js/html5shiv-printshiv.min.js?1554390877"></script>
    <script src="/go-concurrency-limits/js/highlight.pack.js?1554390877"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/go-concurrency-limits/js/modernizr.custom.71422.js?1554390877"></script>
    <script src="/go-concurrency-limits/js/learn.js?1554390877"></script>
    <script src="/go-concurrency-limits/js/hugo-learn.js?1554390877"></script>

    <link href="/go-concurrency-limits/mermaid/mermaid.css?1554390877" type="text/css" rel="stylesheet" />
    <script src="/go-concurrency-limits/mermaid/mermaid.js?1554390877"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

